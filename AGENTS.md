---
AI_CONTEXT: true
VERSION: 0.19.0
LAST_UPDATED: 2026-01-24
TECH_STACK: Bun, React 19, Hono, PostgreSQL 17, Electric SQL, TanStack ecosystem
---

# AGENTS.md

## Quick Reference for AI Agents

### Local Web Browser

When debug with browser, please refer to these addresses to access the application & api:

- **Frontend runs on** `https://hoalu.localhost`
- **Backend API runs on** `https://hoalu.localhost/api`

### Common Tasks Cheat Sheet

- **Add new API route**: Follow 3-file pattern in `apps/api/src/routes/[resource]/` (index.ts, repository.ts, schema.ts)
- **Add database table**: Update `apps/api/src/db/schema.ts:1-346` → `bun run db:generate` → `bun run db:migrate`
- **Add frontend route**: Create file in `apps/app/src/routes/` (file-based routing with TanStack Router)
- **Add UI component**: Place in `apps/app/src/components/` or `packages/ui/src/components/` if reusable
- **Add collection**: Create in `apps/app/src/lib/collections/[resource].ts` with Electric SQL
- **Fix type errors**: Restart dev servers to regenerate RPC types and route definitions

### File Location Quick Lookup

| What                 | Where                                                           | Lines                               |
| -------------------- | --------------------------------------------------------------- | ----------------------------------- |
| Database schema      | `apps/api/src/db/schema.ts`                                     | 346                                 |
| API client types     | `apps/app/src/lib/api-client.ts`                                | 313                                 |
| Frontend schemas     | `apps/app/src/lib/schema.ts`                                    | 111                                 |
| Expense API routes   | `apps/api/src/routes/expenses/`                                 | 3 files (index, repository, schema) |
| Expense components   | `apps/app/src/components/expenses/`                             | 6 files                             |
| Expense live queries | `apps/app/src/components/expenses/use-expenses.ts`              | 255                                 |
| Category components  | `apps/app/src/components/categories/`                           | 3 files                             |
| Wallet components    | `apps/app/src/components/wallets/`                              | 2 files                             |
| Auth setup           | `apps/api/src/lib/auth.ts`                                      | -                                   |
| Sync proxy           | `apps/api/src/modules/sync.ts`                                  | -                                   |
| PGlite provider      | `apps/app/src/components/providers/local-postgres-provider.tsx` | -                                   |
| Collections          | `apps/app/src/lib/collections/*.ts`                             | -                                   |
| Collection factory   | `apps/app/src/lib/collections/create-collection-factory.ts`     | -                                   |
| Query options        | `apps/app/src/services/query-options.ts`                        | -                                   |
| Mutations            | `apps/app/src/services/mutations.ts`                            | -                                   |

### Critical Constraints

**NEVER do these:**

- ❌ Modify `apps/app/src/lib/api-client.ts` - auto-generated from Hono RPC
- ❌ Edit `apps/app/src/routeTree.gen.ts` - generated by TanStack Router
- ❌ Use relative imports like `../../` - use path aliases instead
- ❌ Omit `.ts`/`.tsx` extensions in imports - Bun requirement
- ❌ Skip migrations after schema changes - data loss risk
- ❌ Modify database directly without migrations - Electric SQL will break
- ❌ Create routes without workspace scoping - security issue

**ALWAYS do these:**

- ✅ Use path aliases (`#app/*`, `#api/*`) instead of relative imports
- ✅ Include `.ts`/`.tsx` extensions in all imports (Bun requirement)
- ✅ Run migrations after schema changes: `db:generate` → `db:migrate`
- ✅ Validate with Zod before database operations
- ✅ Scope all data by `workspace_id` foreign key (multi-tenancy)
- ✅ Use middleware chain: `workspaceQueryValidator` → `workspaceMember` → handler
- ✅ Return typed results from repository functions
- ✅ Include OpenAPI documentation for all API routes
- ✅ Use `z.coerce.number()` for Electric SQL numeric fields
- ✅ Restart dev servers after API changes to regenerate types

## Project Overview

**Hoalu** is a modern expense tracking and workspace management application built as a monorepo using Bun and Turbo. It features real-time synchronization, multi-workspace support, offline-first architecture, and a comprehensive API.

## Monorepo Structure

```
hoalu/
├── apps/
│   ├── api/              # Backend Hono API
│   │   ├── src/
│   │   │   ├── db/       # Drizzle schema and connection
│   │   │   ├── lib/      # Auth, Redis, S3, Email utilities
│   │   │   ├── middlewares/  # User session, workspace member
│   │   │   ├── modules/  # API, Auth, OpenAPI, Sync modules
│   │   │   ├── routes/   # CRUD routes (categories, expenses, etc.)
│   │   │   ├── utils/    # Constants, I/O, monetary helpers
│   │   │   └── validators/  # Request validators
│   │   └── migrations/   # Drizzle database migrations
│   │
│   ├── app/              # Frontend React application
│   │   ├── src/
│   │   │   ├── atoms/    # Jotai state atoms
│   │   │   ├── components/  # React components
│   │   │   │   ├── charts/     # Data visualization
│   │   │   │   ├── expenses/   # Expense-specific components
│   │   │   │   ├── forms/      # Form components with TanStack Form
│   │   │   │   ├── layouts/    # Layout components
│   │   │   │   ├── providers/  # Context providers
│   │   │   │   └── wallets/    # Wallet components
│   │   │   ├── helpers/  # Utility functions
│   │   │   ├── hooks/    # Custom React hooks
│   │   │   ├── lib/      # Core libraries
│   │   │   │   ├── collections/  # TanStack DB collections
│   │   │   │   ├── api-client.ts
│   │   │   │   ├── query-key-factory.ts
│   │   │   │   └── schema.ts
│   │   │   ├── routes/   # TanStack Router routes
│   │   │   │   ├── _auth/      # Auth routes
│   │   │   │   └── _dashboard/ # Dashboard routes
│   │   │   ├── services/ # API queries and mutations
│   │   │   └── styles/   # Global styles
│   │   └── public/       # Static assets
│   │
│   └── web/              # Reserved for future web app
│
├── packages/
│   ├── auth/             # Better Auth plugins & workspace management
│   ├── common/           # Shared utilities, enums, validation schemas
│   ├── countries/        # Country, currency, language data
│   ├── email/            # React Email templates
│   ├── furnace/          # Hono server utilities & middleware
│   ├── icons/            # Icon libraries (Lucide, Meteocons, Nucleo, Tabler)
│   ├── themes/           # TailwindCSS theme configurations
│   ├── tsconfig/         # Shared TypeScript configurations
│   └── ui/               # Shared UI components (shadcn/ui based)
│
├── deployments/          # Docker and deployment configs
│   ├── scripts/          # Deployment scripts
│   └── *.Dockerfile      # Container definitions
│
└── package.json          # Root workspace config with catalog
```

### Packages (`/packages`)

#### Core Packages

- **@hoalu/auth** - Better Auth workspace plugin
- **@hoalu/common** - Shared utilities (`datetime`, `monetary`, `schema`, `enums`)
- **@hoalu/countries** - Country/currency data with helpers
- **@hoalu/email** - React Email templates (join-workspace, reset-password, verify-email)
- **@hoalu/furnace** - Hono utilities (error handlers, auth guards, CORS, OpenAPI)
- **@hoalu/icons** - Unified icon exports from multiple libraries
- **@hoalu/themes** - TailwindCSS color themes and base styles
- **@hoalu/tsconfig** - Shared TypeScript configs (base, app, bun, vite)
- **@hoalu/ui** - shadcn/ui components with customizations

## Development Workflow

### Getting Started

```bash
# Install Bun if not already installed
curl -fsSL https://bun.sh/install | bash

# Install Caddy if not already installed (macOS)
brew install caddy

# Install dependencies
bun install

# Start local infrastructure (PostgreSQL, Redis, Electric)
bun run docker:up

# Start Caddy reverse proxy (in project root)
caddy run

# Start development servers (API + App)
bun run dev
```

### Key Commands

**Root Level:**

- `bun run build` - Build all packages and apps (via Turbo)
- `bun run dev` - Start dev servers for all apps
- `bun run docker:up` - Start Docker infrastructure
- `bun run docker:down` - Stop Docker infrastructure

**Caddy:**

```bash
# Start Caddy reverse proxy
caddy run                 # Run in foreground
caddy start               # Run in background
caddy reload              # Reload configuration
caddy stop                # Stop Caddy server
caddy validate            # Validate Caddyfile syntax
```

### Authentication & Authorization

#### Better Auth Setup

**Server** (`apps/api/src/lib/auth.ts`):

```typescript
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { workspacePlugin } from "@hoalu/auth/plugins/workspace";

export const auth = betterAuth({
	database: drizzleAdapter(db, {
		provider: "pg",
	}),
	plugins: [
		workspacePlugin({
			// Custom workspace management
			createWorkspaceOnSignup: true,
			roleHierarchy: ["owner", "admin", "member"],
		}),
	],
	session: {
		expiresIn: 60 * 60 * 24 * 7, // 7 days
		updateAge: 60 * 60 * 24, // 1 day
	},
	emailAndPassword: {
		enabled: true,
		requireEmailVerification: true,
	},
});
```

**Client** (`apps/app/src/lib/auth-client.ts`):

```typescript
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
	baseURL: import.meta.env.PUBLIC_API_URL,
});

export const { useSession, signIn, signOut } = authClient;
```

**Middleware** (`apps/api/src/middlewares/workspace-member.ts`):

```typescript
export const workspaceMember = createMiddleware(async (c, next) => {
	const session = c.var.session;
	const { workspaceId } = c.var.workspace;

	const member = await db
		.select()
		.from(memberTable)
		.where(and(eq(memberTable.workspaceId, workspaceId), eq(memberTable.userId, session.userId)))
		.limit(1);

	if (!member.length) {
		return c.json({ error: "Not a workspace member" }, 403);
	}

	c.set("member", member[0]);
	await next();
});
```

#### Workspace Management

**Multi-tenancy Pattern:**

- All data scoped by `workspace_id` foreign key
- Slug-based routing: `/dashboard/:slug/expenses`
- Member roles: `owner`, `admin`, `member`
- Invitation system with expiration

**Workspace Context:**

```typescript
// hooks/use-workspace.ts
export function useWorkspace() {
	const params = Route.useParams(); // TanStack Router
	const { data: workspace } = useSuspenseQuery(getWorkspaceQueryOptions(params.slug));
	return workspace;
}
```

## Code Conventions

### Path Aliases

**Apps use `#app/*` and `#api/*`:**

```json
// apps/app/package.json
{
  "imports": {
    "#app/*": "./src/*"
  }
}

// apps/api/package.json
{
  "imports": {
    "#api/*": "./src/*"
  }
}
```

**Packages use `#<package-name>/*`:**

```json
// packages/common/package.json
{
	"imports": {
		"#common/*": "./src/*"
	}
}
```

**Why it's used:**

- Electric SQL sends numeric values as strings for precision
- Zod coerces them back to JavaScript numbers
- Maintains type safety throughout the pipeline

### Import Paths

Always use the configured path aliases:

- ✅ `import { useAuth } from "#app/hooks/use-auth.ts"`
- ❌ `import { useAuth } from "../../hooks/use-auth.ts"`

### File Extensions

Always include `.ts` or `.tsx` extensions in imports:

- ✅ `import { schema } from "./schema.ts"`
- ❌ `import { schema } from "./schema"`

### Zod v4 Coercion

**`z.coerce.number()`** - Automatically converts string inputs to numbers:

```typescript
const schema = z.object({
	amount: z.coerce.number(), // "123" → 123
	quantity: z.coerce.number().int(), // "5" → 5
});

schema.parse({ amount: "123.45", quantity: "5" });
// → { amount: 123.45, quantity: 5 }
```

### TypeScript Conventions

**Function Components:**

```typescript
import type { ReactNode } from "react"

interface ButtonProps {
  children: ReactNode
  variant?: "primary" | "secondary"
  onClick?: () => void
}

export function Button({ children, variant = "primary", onClick }: ButtonProps) {
  return (
    <button onClick={onClick} className={cn("btn", `btn-${variant}`)}>
      {children}
    </button>
  )
}
```

**Custom Hooks:**

```typescript
export function useExpenses(workspaceId: string) {
	const { data, isLoading, error } = useQuery(getExpensesQueryOptions(workspaceId));

	return { expenses: data ?? [], isLoading, error };
}
```

**Type Inference from Functions:**

```typescript
export function useExpenseLiveQuery() {
	// ... implementation
}

// Export inferred types
export type ExpensesClient = ReturnType<typeof useExpenseLiveQuery>;
export type ExpenseClient = ExpensesClient[number];
```

**Zod Schema Patterns:**

```typescript
// Define schema
export const ExpenseFormSchema = z.object({
	title: z.string().min(1),
	amount: z.coerce.number(), // Coerce string to number
	currency: CurrencySchema,
	date: z.iso.datetime(),
	walletId: z.uuidv7(),
	categoryId: z.uuidv7(),
	repeat: RepeatSchema,
});

// Infer TypeScript type
export type ExpenseFormSchema = z.infer<typeof ExpenseFormSchema>;

// Partial for updates
export const UpdateExpenseSchema = ExpenseFormSchema.partial();
```

**Hono RPC Client Types:**

```typescript
import type { InferRequestType, InferResponseType } from "hono/client";
import type { honoClient } from "#app/lib/api-client.ts";

// Infer response type
export type ExpenseSchema = InferResponseType<
	typeof honoClient.api.expenses.$get,
	200
>["data"][number];

// Infer request type
export type ExpensePostSchema = InferRequestType<typeof honoClient.api.expenses.$post>["json"];
```

### Component Patterns

**Early Returns for Loading/Error States:**

```typescript
export function ExpenseList() {
  const expenses = useExpenseLiveQuery()

  if (!expenses.length) {
    return <EmptyState message="No expenses found" />
  }

  return (
    <div>
      {expenses.map((expense) => (
        <ExpenseItem key={expense.id} expense={expense} />
      ))}
    </div>
  )
}
```

**Compound Components:**

```typescript
export function ExpenseDetails({ expense }: { expense: ExpenseClient }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{expense.title}</CardTitle>
        <CardDescription>{expense.category?.name}</CardDescription>
      </CardHeader>
      <CardContent>
        <CurrencyValue
          value={expense.amount}
          currency={expense.currency}
        />
      </CardContent>
      <CardFooter>
        <ExpenseActions expenseId={expense.id} />
      </CardFooter>
    </Card>
  )
}
```

## Environment Configuration

### Environment Variables

**API (`apps/api/.env`):**

```bash
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=hoalu

# Electric SQL
SYNC_URL=http://localhost:4000
SYNC_SECRET=your-sync-secret

# Better Auth
BETTER_AUTH_SECRET=your-auth-secret
BETTER_AUTH_URL=http://localhost:3000

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# S3 (optional)
S3_ENDPOINT=
S3_REGION=
S3_BUCKET=
S3_ACCESS_KEY=
S3_SECRET_KEY=

# Email (optional)
EMAIL_FROM=noreply@hoalu.app
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
```

**App (`apps/app/.env`):**

```bash
# API URL (via Caddy proxy)
PUBLIC_API_URL=http://hoalu.localhost/api

# App URL (via Caddy proxy)
PUBLIC_APP_BASE_URL=http://hoalu.localhost
```

**Note:** When using Caddy reverse proxy:

- Frontend runs on `localhost:5173` internally, served via Caddy at `hoalu.localhost`
- API runs on `localhost:3000` internally, served via Caddy at `hoalu.localhost/api`
- All browser requests go through Caddy for compression and optional HTTPS
- `.localhost` domains work natively without `/etc/hosts` modification

For HTTPS setup, change URLs to `https://hoalu.localhost` and `https://hoalu.localhost/api`

### Docker Services

**Infrastructure Stack:**

```yaml
# docker-compose.local.yml
services:
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: hoalu
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    command:
      - -c
      - wal_level=logical # Required for Electric SQL
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  electric:
    image: electricsql/electric:latest
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/hoalu
      ELECTRIC_WRITE_TO_PG_MODE: logical_replication
      AUTH_MODE: secure
      AUTH_JWT_SECRET: ${SYNC_SECRET}
    ports:
      - "4000:4000"
    depends_on:
      - postgres
```

**Start Services:**

```bash
cd deployments
docker compose -f docker-compose.local.yml up -d
```
